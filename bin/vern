#!/usr/bin/env node

var program        = require('commander'),
    os             = require('os'),
    fs             = require('fs-extra'),
    exec           = require('child_process').exec,
    prompt         = require('prompt'),
    template_dir   = './templates',
    project_dir    = template_dir + '/projects',
    controller_dir = template_dir + '/controller',
    model_dir      = template_dir + '/model',
    route_dir      = template_dir + '/route',
    view_dir       = template_dir + '/view',
    pkg            = fs.readJsonSync('./package.json');

program
  .version(pkg.version)
  .usage('[command] [options]')
  .option('project, --project <path>', 'Create a new project', buildProject)
  .option('controller, --controller <name>', 'Create a controller when inside a project folder', buildController)
  .option('route, --route <path>', 'Create a route when inside a project folder', buildRoute)
  .option('model, --model <name>', 'Create a model when inside a project folder', buildModel)
  .option('view, --view <name>', 'Create a view when inside a project folder', buildView)
  .option('deploy, --deploy <stage>', 'Create a view when inside a project folder', deployApp)
  .option('config, --config', 'Configure your app when inside a project folder', configApp)
  .parse(process.argv);

function buildProject(path, overwrite) {
  if(!path) {
    path = '.';
  }
  console.log("Setting up VERN now!".green);
  prompt.message = '';
  prompt.start();
  if(fs.existsSync(path)) {
    prompt.get({
      name: 'overwrite',
      message: 'Overwrite the existing directory?',
      validator: /y[es]*|n[o]?/,
      warning: 'Must respond yes or no',
      default: 'no'
    }, function(err, res) {
      if(err) {
        return console.log(err);
      }

      if(res.overwrite.charAt(0) === 'y') {
        copyProject(path);
      } else {
        console.log('Not going to overwrite. Good bye!'.red);
      }
    });
  } else {
    copyProject(path);
  }
}

function copyProject(path) {
  fs.copy(template_dir + '/project', path, function(err) {
    if(err) {
      return console.log(err);
    }
    console.log('Created project in: ' + path.green);
    fs.outputJson(path + '/vern.json', {
      version: pkg.version
    }, function(err) {
      if(err) {
        return console.log(err);
      }

      console.log('Created ' + (path + '/vern.json').green);
      // Now we will prompt the user to start adding base routes, controllers, and models.
      // We can also setup a deployment strategy(ies)
    });
  });
}

function buildController(name) {

}

function buildRoute(path) {

}

function buildModel(name) {

}

function buildView(name) {

}

function deployApp(stage) {

}

function configApp() {

}